const API_BASE = 'https://scavenger-hunt-worker.davidlosonczi.workers.dev/api';
let sessionId = 'session_' + Math.random().toString(36).substr(2, 9); // simple session
let foundHints = [];
let totalHints = 0;

const openCameraBtn = document.getElementById('openCamera');
const cameraContainer = document.getElementById('cameraContainer');
const video = document.getElementById('video');
const snapBtn = document.getElementById('snap');
const counter = document.getElementById('counter');
const message = document.getElementById('message');

openCameraBtn.addEventListener('click', async () => {
  openCameraBtn.classList.add('hidden');
  cameraContainer.classList.remove('hidden');

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
  } catch (err) {
    alert('Camera access denied or unavailable.');
    console.error(err);
  }
});

snapBtn.addEventListener('click', async () => {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(async (blob) => {
    if (!blob) return;

    const formData = new FormData();
    formData.append('sessionId', sessionId);
    formData.append('file', blob, 'photo.jpg');

    try {
      const res = await fetch(`${API_BASE}/upload`, { method: 'POST', body: formData });
      const data = await res.json();

      if (data.success) {
        foundHints.push(data.hint || '');
        message.textContent = data.message;
        updateCounterDisplay(data.progress);

        if (data.progress >= totalHints) {
          alert('ðŸŽ‰ Congratulations! You found all hints!');
        }
      } else {
        message.textContent = data.message || 'Text not found';
      }
    } catch (err) {
      console.error(err);
      message.textContent = 'Upload failed';
    }
  }, 'image/jpeg');
});

// On page load, fetch totalHints from backend
async function init() {
  try {
    const res = await fetch(`${API_BASE}/admin/hints`);
    const data = await res.json();
    totalHints = data.totalHints || 15; // fallback
    updateCounterDisplay(0);
  } catch (err) {
    console.error('Failed to fetch total hints', err);
    totalHints = 15;
    updateCounterDisplay(0);
  }
}

function updateCounterDisplay(foundCount) {
  counter.textContent = `${foundCount}/${totalHints}`;
}

// Initialize on page load
init();
