<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KincskeresÃ©s</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">

<div id="app" class="max-w-md w-full bg-white p-6 rounded-2xl shadow text-center">
  <h1 class="text-2xl font-bold mb-4">KincskeresÃ©s</h1>
  <p id="counter" class="mb-4 text-lg">0 / 0</p>

  <div id="cameraContainer" class="hidden flex flex-col items-center">
    <video id="video" class="w-full rounded mb-2" autoplay playsinline></video>
    <button id="snap" class="bg-indigo-600 text-white px-4 py-2 rounded mb-2">RÃ¶gzÃ­tÃ©s</button>
  </div>

  <button id="openCamera" class="bg-green-600 text-white px-4 py-2 rounded">Kamera megnyitÃ¡sa</button>
  <p id="message" class="mt-4 text-sm text-gray-700"></p>
</div>

<!-- Full page victory modal (hidden) -->
<div id="victoryModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-3xl p-8 max-w-lg w-full mx-4 text-center shadow-2xl">
    <h2 class="text-3xl font-extrabold mb-4">ğŸ‰ GratulÃ¡lok! MegtalÃ¡ltÃ¡l minden kincset! Jobb vagy mint Jack Sparrow! ğŸ‰</h2>
    <p id="victoryDuration" class="text-lg mb-2"></p>
    <div id="victoryList" class="text-left max-h-64 overflow-auto mb-4"></div>
    <div class="flex justify-center gap-3">
      <button id="restartBtn" class="bg-gray-200 px-4 py-2 rounded">Ãšjra</button>
      <button id="closeBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Csaosz</button>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://scavenger-hunt-worker.davidlosonczi.workers.dev/api';
let sessionId = 'session_' + Math.random().toString(36).substr(2,9);
let totalHints = 0;
let foundCount = 0;

const openCameraBtn = document.getElementById('openCamera');
const cameraContainer = document.getElementById('cameraContainer');
const video = document.getElementById('video');
const snapBtn = document.getElementById('snap');
const counter = document.getElementById('counter');
const message = document.getElementById('message');

const victoryModal = document.getElementById('victoryModal');
const victoryDuration = document.getElementById('victoryDuration');
const victoryList = document.getElementById('victoryList');
const closeBtn = document.getElementById('closeBtn');
const restartBtn = document.getElementById('restartBtn');

openCameraBtn.addEventListener('click', async () => {
  openCameraBtn.classList.add('hidden');
  cameraContainer.classList.remove('hidden');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
  } catch (e) {
    alert('Kamara hozzÃ¡fÃ©rÃ©s megtagadva vagy nem Ã©rhetÅ‘ el.');
    console.error(e);
  }
});

snapBtn.addEventListener('click', async () => {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(async (blob) => {
    if (!blob) return;
    const fd = new FormData();
    fd.append('sessionId', sessionId);
    fd.append('file', blob, 'photo.jpg');

    try {
      const res = await fetch(`${API_BASE}/upload`, { method: 'POST', body: fd });
      const data = await res.json();
      if (data.success) {
        message.textContent = data.message;
        foundCount = data.progress;
        updateCounter();
        if (foundCount >= data.total) {
          // Final hint found: notify backend to create completed record
          await finalizeGame();
        }
      } else {
        message.textContent = data.message || 'A szÃ¶veg nem talÃ¡lhatÃ³.';
      }
    } catch (e) {
      console.error(e);
      message.textContent = 'FeltÃ¶ltÃ©si hiba tÃ¶rtÃ©nt.';
    }
  }, 'image/jpeg');
});

async function fetchTotalHints() {
  try {
    const res = await fetch(`${API_BASE}/hints`);
    const data = await res.json();
    totalHints = data.totalHints || 0;
    updateCounter();
  } catch (e) {
    console.error('Nem sikerÃ¼lt betÃ¶lteni a kincseket', e);
    totalHints = 0;
    updateCounter();
  }
}

function updateCounter() {
  counter.textContent = `${foundCount}/${totalHints}`;
}

async function finalizeGame() {
  try {
    const res = await fetch(`${API_BASE}/game-complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId })
    });
    const result = await res.json();
    if (result.success && result.completed) {
      showVictory(result.completed);
    } else {
      console.warn('A jÃ¡tÃ©k befejezÃ©sÃ©t jelzÅ‘ hÃ­vÃ¡s nem adott vissza befejezett rekordot', result);
      // still show simple modal
      showVictory({ start: null, finish: new Date().toISOString(), durationMs: 0, ordered: [] });
    }
  } catch (e) {
    console.error('Nem sikerÃ¼lt a jÃ¡tÃ©kot lezÃ¡rni', e);
    showVictory({ start: null, finish: new Date().toISOString(), durationMs: 0, ordered: [] });
  }
}

function showVictory(completed) {
  // Build readable duration
  const ms = completed.durationMs || 0;
  const s = Math.floor(ms / 1000);
  const minutes = Math.floor(s / 60);
  const seconds = s % 60;
  victoryDuration.textContent = `Time: ${minutes}m ${seconds}s`;

  // Fill ordered list
  victoryList.innerHTML = '';
  if (Array.isArray(completed.ordered) && completed.ordered.length) {
    completed.ordered.forEach((h, i) => {
      const div = document.createElement('div');
      div.className = 'py-1 border-b';
      div.innerHTML = `<strong>#${i+1}</strong> ${h.text || h.id} <span class="text-sm text-gray-500">(${h.ts || '-'})</span>`;
      victoryList.appendChild(div);
    });
  } else {
    victoryList.innerHTML = '<div class="text-sm text-gray-600">No details available</div>';
  }
  // Show modal
  victoryModal.classList.remove('hidden');
  victoryModal.classList.add('flex');

  // --- CONFETTI ---
  confetti({
    particleCount: 200,
    spread: 100,
    origin: { y: 0.6 }
  });
}

closeBtn.addEventListener('click', () => {
  victoryModal.classList.add('hidden');
  victoryModal.classList.remove('flex');
});

restartBtn.addEventListener('click', () => {
  // simple reload to restart game
  location.reload();
});

// init
fetchTotalHints();
</script>
</body>
</html>
